#!/bin/ruby

class TmuxProcfileRunner
  def call
    new_tmux_session unless in_tmux?
    run_procfile
    attach_to_session
  end

  private

  def attach_to_session
    `tmux attach-session -t #{project_name}"`
  end

  def project_name
    Dir.pwd.split("/").last
  end

  def in_tmux?
    `! [ -z $TMUX ]`
  end

  def ensure_in_tmux
    `tmux` unless in_tmux?
  end

  def new_tmux_session
    `tmux new-session -d -s #{project_name}`
  end

  def new_tmux_window(name:, command:)
    `tmux new-window -d -n #{name} #{command}`
  end

  def ensure_tmux_window(name:, command: nil)
    new_tmux_window(name: name, command: command) unless tmux_window_exists?(name)
  end

  def tmux_window_exists?(name)
    `tmux list-windows -F #{window_name} | grep #{name} >/dev/null`
  end

  def hashify_procfile
    File.readlines("Procfile").map { |line| line.chomp.split(":") }.to_h
  end

  def run_procfile
    hashify_procfile.each do |name, command|
      ensure_tmux_window(name: name, command: command)
    end
  end
end

if __FILE__ == $PROGRAM_NAME
  TmuxProcfileRunner.new.call
end
